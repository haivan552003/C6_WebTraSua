@page "/getproduct"
@inject IJSRuntime jsRuntime

<p> <a href="createproduct">Thêm Sản phẩm</a></p>
<div class="panel panel-primary">
    <!-- Default panel contents -->
    <div class="panel-heading"><h2>Thông tin sản phẩm</h2></div>

    <!-- Table -->
    <table class="table">
        <tr>
            <th>Tên Sản Phẩm</th>
            <th>Hình Ảnh</th>
            <th>Đánh giá</th>
            <th>Danh Mục</th>
            <th>Trạng Thái</th>
            <th>Khác</th>
        </tr>
        @foreach (Product item in product)
        {
            <tr>
                <td>@item.Name</td>
                <td>
                    @if (item.Image != null && item.Image.Count > 0)
                    {
                        <img src="@GetImagePath(item.Image.First().Name)"
                             width="100" height="100" alt="Product Image">
                    }
                    else
                    {
                        <span>Không có hình ảnh</span>
                    }
                </td>
                <td>@item.Rate</td>
                <td>@item.Categories.Name</td>
                <td>
                    @{
                        if (item.StatusID == 0)
                        {
                            <span>Hợp Lệ</span>
                        }
                        else if (item.StatusID == 1)
                        {
                            <span>Không Hợp Lệ</span>
                        }
                    }
                </td>
                <td>
                    <a class="btn btn-sm btn-success" href="updatepro/@item.ProductID">
                        Sửa
                    </a>
                </td>
            </tr>
        }
    </table>
</div>



@code {
    string imageBasePath = "http://localhost:49972/images/";
    string urlPro = "http://localhost:20714/api/Products";

    private bool IsLoggedIn = false;
    private int RoleID = 0;

    public List<Product> product { get; set; } = new List<Product>();

    protected async override Task OnInitializedAsync()
    {
        await CallAPI();
        await GetSession();
    }

    private async Task GetSession()
    {
        var userInfoJson = await jsRuntime.InvokeAsync<string>("sessionStorage.getItem", "userSession");
        if (!string.IsNullOrEmpty(userInfoJson))
        {
            var userInfo = JsonConvert.DeserializeObject<UserLogin>(userInfoJson);
            if (userInfo != null)
            {
                IsLoggedIn = true;
                RoleID = userInfo.RoleID;
            }
        }
    }

    async Task CallAPI()
    {
        using (var httpClient = new HttpClient())
        {
            using (var response = await httpClient.GetAsync(urlPro))
            {
                string apiResponse = await response.Content.ReadAsStringAsync();
                product = JsonConvert.DeserializeObject<List<Product>>(apiResponse);
            }
        }
    }

    private string GetImagePath(string imageName) => $"{imageBasePath}{imageName}";

}
